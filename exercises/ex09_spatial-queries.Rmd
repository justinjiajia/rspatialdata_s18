---
title: "<span class='ex-title'>Spatial Analysis with R:</span><br/><span class='ex-subtitle'>Exercise 9: Spatial Queries</span>"
date: "`r load('../common/course_info.RData'); lstCI$course`"
output: 
  html_document: 
    css: "../common/slidy_styles.css"
    self_contained: no
    lib_dir: lib
    smart: no
    includes:
      in_header: "../common/header.html"
      after_body: bottom_links.html
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::knit_hooks$set(small.mar = function(before, options, envir) {
    if (before) par(mar = c(2, 2, 0.5, 0.5))
})
source("auton_chop.R")
load('../common/course_info.RData')
library(rgdal)
library(rgeos)
```

### Instructions

- If you haven't already, install [R](https://cran.r-project.org/) and [RStudio](https://www.rstudio.com/products/rstudio/download/). 

- Download the <a href="`r lstCI$githubrepo`" target="_blank">GitHub repo</a>. 

- Create a new R script in RStudio (File &rarr; New File &rarr; R Script). 

- Copy the questions below (all of which begin with the _#_ character so RStudio will interpret them as a comment) into your script. Under each question, write R code. Run each line of R code as you enter it (press the Run button or ctrl+enter) to make sure it works.

- Remember to save your script periodically to avoid losing work if RStudio crashes.

- If you get stuck, click on the 'hint' link, or the question number to see the answer. Click again to hide.

- If you have any questions or problems, please feel free to email the instructor.

<hr class="hrdivider">
<div class="copy-button"><button onclick="CopyToClipboard('qtn_div');return false;">Copy questions</button></div>
<div id="qtn_div" class="ex-qtn">

`r hashtitle("Analyze Crimes in a San Francisco Neighborhood")`  

<a id="qtn_swxdzr" href="#" class="showhidelink" onclick="showHide('swxdzr');return false;">\# `r auton()`</a> `r chop("Import the San Francisco neighborhoods. Select just one (e.g, Haight Ashbury). Save the boundary to a new variable, and plot it.")` <a href="#" class="showhidehint" onclick="showHide('iezehr');return false;"></a>  

<div id="iezehr" class="hint">See [Exercise 3](ex03_import_plot.html#qtn_zizsuk)</div>
  

<div id="swxdzr" class="answer-code">
```{r swxdrz, cache=TRUE, fig.align='center', small.mar=TRUE}
library(rgdal, quietly = TRUE)
sfnb_ll <- readOGR("data", "sf_neighborhoods")
plot(sfnb_ll, axes=T, asp=1)
haight_ll <- sfnb_ll[sfnb_ll$nhood=="Haight Ashbury", ]
plot(haight_ll, axes=TRUE, asp=1)
```
</div>


<a id="qtn_abnwfz" href="#" class="showhidelink" onclick="showHide('abnwfz');return false;">\# `r auton()`</a> `r chop("Import the San Francisco Crimes Database from the sf_crime file GeoDB.")` <a href="#" class="showhidehint" onclick="showHide('qtyyke');return false;"></a>  

<div id="qtyyke" class="hint">See [Importing from a File Geodatabase with rgdal](part01d_import_plot.html#import-from-a-geodatabase)</div>


<div id="abnwfz" class="answer-code">
```{r import_sf_crimes, cache=TRUE}
gdb_dir <- "data/sf_crime.gdb"
file.exists(gdb_dir)
rgdal::ogrListLayers(gdb_dir)
sfcrime_sp <- rgdal::readOGR(dsn=gdb_dir,layer="San_Francisco_Crimes")
class(sfcrime_sp)
```
</div>

<a id="qtn_zpzoim" href="#" class="showhidelink" onclick="showHide('zpzoim');return false;">\# `r auton()`</a> `r chop("Find out how many crimes occurred in your selected neighborhood.")` <a href="#" class="showhidehint" onclick="showHide('bhssvm');return false;"></a>  

<div id="bhssvm" class="hint">Remember that in order to do a spatial overlay operation, both layers must have the same CRS.<br/>Use the <tt>sp:over()</tt> function, so you can keep the data frame (unlike <tt>rgeos::gIntersection()</tt>). </div>

<div id="zpzoim" class="answer-code">
First let's inspect the *proj4string* slot of both layers.

```{r}
sfcrime_sp@proj4string
haight_ll@proj4string
```

The crime locations are projected, while neighborhood boundaries are not. So before we can do a spatial overlay, we have to get them in the same CRS. Let's project the neighborhood boundary into the projection system of the crime data.

```{r prj_crimes_haight, cache=TRUE, small.mar=TRUE, fig.align='center'}
haight_prj <- sp::spTransform(haight_ll, sfcrime_sp@proj4string)
plot(haight_prj, axes=TRUE, asp=1)
plot(sfcrime_sp, add=TRUE, col="red", pch=16, cex=0.5)
```

Now we can do the spatial overlay. Note how we use the <tt>sp::geometry()</tt> function to strip off the data frame, so that <tt>sp::over()</tt> returns for each point the index (row number) of the polygon it falls in (and NA if there's no overlap).

```{r intersect_crimes_haight, cache=TRUE, small.mar=TRUE, fig.align='center'}
crimept_polyid <- sp::over(sp::geometry(sfcrime_sp), sp::geometry(haight_prj))
sum(is.na(crimept_polyid))
sum(!is.na(crimept_polyid))
haight_crime_pts <- sfcrime_sp[!is.na(crimept_polyid),]
plot(haight_prj, axes=TRUE, asp=1)
plot(haight_crime_pts, add=TRUE, col="purple", pch=16, cex=0.5)
nrow(haight_crime_pts@data)
```

There are `r nrow(haight_crime_pts@data)` crimes in this neighborhood.

</div>

<a id="qtn_lerzpa" href="#" class="showhidelink" onclick="showHide('lerzpa');return false;">\# `r auton()`</a> `r chop("What was the most common type of crime?")`  

<div id="lerzpa" class="answer-code">
```{r}
head(haight_crime_pts@data)
sort(table(haight_crime_pts@data$Category), decreasing = TRUE)
```

It looks like non-criminal citations are the most common offense.
</div>

`r hashtitle("Generate Random Points in a Polygon")`  

<a id="qtn_kqrtya" href="#" class="showhidelink" onclick="showHide('kqrtya');return false;">\# `r auton()`</a> `r chop("Generate 50 random points that fall within your selected neighborhood.")` <a href="#" class="showhidehint" onclick="showHide('jgvuvk');return false;"></a>  

<div id="jgvuvk" class="hint">Because the neighborhood boundary is not rectangular, we can i) generate many more than 50 random points within the extent (bounding box), ii) filter out those that don't fall within the boundary, iii) of the remaining, randomly select 50.</div>

<div id="kqrtya" class="answer-code">

```{r tddhw, cache=TRUE, fig.align='center', small.mar=TRUE}
## Get the bounding box
hbb <- haight_ll@bbox
hbb
num_pts <- 250
xs <- runif(min=hbb[1,1], max=hbb[1,2], n=num_pts)
ys <- runif(min=hbb[2,1], max=hbb[2,2], n=num_pts)
samp_pts_ext <- SpatialPoints(data.frame(xs,ys), proj4string = haight_ll@proj4string)
plot(haight_ll, axes=TRUE, asp=1)
plot(samp_pts_ext, add=TRUE, col="red", pch=16, cex=0.5)
```

Next, we use a spatial ovelay to get rid of the points outside the boundary. We can use either <tt>sp::over()</tt> or <tt>rgeos::gIntersection()</tt>. <tt>gIntersection()</tt> requires fewer gymnastics so we'll go with that.

```{r remove_pts_outside, cache=TRUE, fig.align='center', small.mar=TRUE}
library(rgeos)
samp_pts_bnd <- rgeos::gIntersection(samp_pts_ext, haight_ll)
plot(haight_ll, axes=TRUE, asp=1)
plot(samp_pts_bnd, add=TRUE, col="purple", pch=16, cex=0.5)
```

Determine how many points fall within the neighborhood.

```{r num_pts, cache=TRUE, fig.align='center', small.mar=TRUE}
length(samp_pts_bnd)
```

That's too many. Randomly select 50 of the points.

```{r fifty_pts, cache=TRUE, fig.align='center', small.mar=TRUE}
idx <- sample(1:length(samp_pts_bnd), size=50, replace=FALSE)
samp_50pts_bnd <- samp_pts_bnd[idx,]
plot(haight_ll, axes=TRUE, asp=1)
plot(samp_50pts_bnd, add=TRUE, col="purple", pch=16, cex=0.5)

```

</div>

</div><!-- end questions -->
